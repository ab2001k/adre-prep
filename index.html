<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADRE 3.0 Pro</title>
    <link rel="icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        OneSignal.Debug.setLogLevel("trace");
        await OneSignal.init({
          appId: "f1fddec2-1dd5-47b4-b35f-ca39df0bd164",
          safari_web_id: "web.onesignal.auto.662c778c-4ab6-4517-8ad0-9e9a32a53670",
          notifyButton: { enable: false },
        });
        if (Notification.permission === "denied") document.getElementById('perm-warning').style.display = 'block';
        setTimeout(() => { OneSignal.Slidedown.promptPush(); }, 3000);
      });
    </script>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- GLOBAL STYLES --- */
        :root { --glass-bg: rgba(255, 255, 255, 0.05); --glass-border: 1px solid rgba(255, 255, 255, 0.1); --neon-blue: #00f2ff; --text-color: #ffffff; --wrong-red: #ff4b4b; --correct-green: #00ff88; }
        
        body { 
            margin: 0; 
            font-family: 'Outfit', sans-serif; 
            background: radial-gradient(circle at top, #1b2735 0%, #090a0f 100%); 
            color: var(--text-color); 
            min-height: 100vh; 
            overflow-x: hidden;
            /* DISABLE SELECTION (Make Non-Copiable) */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #perm-warning { display: none; background: rgba(255, 75, 75, 0.15); backdrop-filter: blur(10px); color: #ff4b4b; text-align: center; padding: 10px; font-size: 13px; border-bottom: 1px solid rgba(255, 75, 75, 0.3); position: sticky; top: 0; z-index: 1001; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo-area h2 { margin: 0; font-weight: 700; letter-spacing: 1px; } .logo-area span { color: var(--neon-blue); }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .notif-btn { background: var(--glass-bg); border: var(--glass-border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; font-size: 20px; }
        .red-dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ff4b4b; border-radius: 50%; box-shadow: 0 0 5px #ff4b4b; display: none; }
        .login-btn-header { background: var(--neon-blue); color: #000; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 14px; }
        
        .user-badge { display: none; font-size: 14px; font-weight: bold; color: #00ff88; border: 1px solid #00ff88; padding: 5px 12px; border-radius: 20px; background: rgba(0, 255, 136, 0.1); text-transform: capitalize; cursor: pointer; font-family: 'Outfit', sans-serif; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; right: -320px; width: 280px; height: 100vh; background: rgba(13, 14, 20, 0.95); backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.1); transition: 0.4s; z-index: 1000; padding: 20px; box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
        .sidebar.active { right: 0; } .close-sidebar { text-align: right; cursor: pointer; color: #aaa; margin-bottom: 20px; }
        .notif-item { padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 10px; border-left: 3px solid var(--neon-blue); }
        .notif-item h4 { margin: 0 0 5px 0; font-size: 14px; } .notif-item p { margin: 0; font-size: 12px; color: #bbb; }
        
        /* PAGE CONTENT */
        .page-content { padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-top: 20px; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(12px); border: var(--glass-border); border-radius: 20px; padding: 25px 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; animation: float 6s ease-in-out infinite; }
        .glass-card:hover { background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); transform: scale(1.02); animation-play-state: paused; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0px); } }
        .icon { font-size: 32px; display: block; margin-bottom: 10px; } .card-title { font-weight: 600; font-size: 16px; margin-bottom: 5px; } .card-sub { font-size: 12px; color: #aaa; }
        
        /* SUBJECT PAGE */
        #subject-page { display: none; }
        .back-btn { background: transparent; border: 1px solid #aaa; color: #aaa; padding: 8px 16px; border-radius: 20px; cursor: pointer; margin-bottom: 20px; }
        .chapter-list { list-style: none; padding: 0; }
        .chapter-item { background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; }
        .chapter-item.attempted { border-left: 4px solid #00ff88; background: rgba(0, 255, 136, 0.05); }
        .chapter-item.attempted span:first-child { color: #00ff88; } .chapter-item.attempted .lock-indicator { color: #00ff88; }
        .chapter-item.locked-referral { border-left: 4px solid #ffcc00; opacity: 0.8; }
        .chapter-item.locked-referral .lock-indicator { color: #ffcc00; }
        
        /* --- LEADERBOARD STYLES (IMPROVED) --- */
        .leaderboard-container { 
            margin-top: 40px; 
            background: rgba(13, 14, 20, 0.6); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .lb-title { 
            text-align: center; 
            font-size: 20px; 
            color: var(--neon-blue); 
            padding: 20px 0 10px 0; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            font-weight: 700;
        }
        
        /* Header Row */
        .lb-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #888;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .lb-list { 
            list-style: none; 
            padding: 0; 
            margin: 0;
            max-height: 400px; 
            overflow-y: auto; 
            /* Custom Scrollbar */
            scrollbar-width: thin; 
            scrollbar-color: #333 transparent;
        }
        
        .lb-list::-webkit-scrollbar { width: 6px; }
        .lb-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        .lb-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.03); 
            align-items: center; 
            transition: 0.2s;
        }
        .lb-item:hover { background: rgba(255,255,255,0.03); }

        .lb-left-grp { display: flex; align-items: center; gap: 15px; flex: 1; }

        /* Rank */
        .lb-rank { 
            width: 25px; font-weight: bold; color: #666; font-size: 14px; text-align: center;
        }
        
        /* Avatar */
        .lb-avatar {
            width: 32px; height: 32px; 
            background: linear-gradient(135deg, #333, #555);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .lb-name { 
            text-align: left; font-size: 14px; color: #ddd; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px;
        }
        .lb-score { font-weight: bold; color: #00ff88; font-size: 14px; }

        /* MEDALS - TOP 3 */
        .rank-1 .lb-rank { content: "ü•á"; font-size: 20px; text-indent: -1000px; position: relative; } 
        .rank-1 .lb-rank::after { content: "ü•á"; position: absolute; top: -5px; left: 0; text-indent: 0; } 
        .rank-1 { background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; }
        .rank-1 .lb-avatar { background: #ffd700; color: #000; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); border:none; }

        .rank-2 .lb-rank { content: "ü•à"; font-size: 20px; text-indent: -1000px; position: relative; } 
        .rank-2 .lb-rank::after { content: "ü•à"; position: absolute; top: -5px; left: 0; text-indent: 0; } 
        .rank-2 { background: rgba(192, 192, 192, 0.1); border-left: 3px solid #c0c0c0; }
        .rank-2 .lb-avatar { background: #c0c0c0; color: #000; box-shadow: 0 0 10px rgba(192, 192, 192, 0.4); border:none; }

        .rank-3 .lb-rank { content: "ü•â"; font-size: 20px; text-indent: -1000px; position: relative; } 
        .rank-3 .lb-rank::after { content: "ü•â"; position: absolute; top: -5px; left: 0; text-indent: 0; } 
        .rank-3 { background: rgba(205, 127, 50, 0.1); border-left: 3px solid #cd7f32; }
        .rank-3 .lb-avatar { background: #cd7f32; color: #000; box-shadow: 0 0 10px rgba(205, 127, 50, 0.4); border:none; }


        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: #1a1f2e; border: 1px solid #444; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; position: relative; }
        .input-field { width: 90%; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #222; color: white; margin-bottom: 12px; font-family: 'Outfit', sans-serif; }
        .submit-btn { background: var(--neon-blue); color: #000; border: none; width: 100%; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* DEV & FEEDBACK STYLES */
        .dev-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--neon-blue); margin-bottom: 10px; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); }
        .dev-role { color: #aaa; font-size: 12px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; display: block;}
        .dev-bio { font-size: 13px; color: #ddd; line-height: 1.6; margin: 10px 0; font-style: italic; }
        .dev-contact { color: var(--neon-blue); text-decoration: none; font-size: 14px; font-weight: bold; display:block; margin-bottom:15px; }
        textarea { width: 100%; height: 80px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 10px; color: white; padding: 10px; font-family: 'Outfit', sans-serif; margin-top: 10px; box-sizing: border-box; resize: none; }
    </style>
</head>
<body oncontextmenu="return false;"> 
    <div id="perm-warning">
        ‚ö†Ô∏è Notifications are blocked. Click the <b>Padlock icon</b> in your address bar to Allow them for Exam Updates.
    </div>

    <div id="sidebar" class="sidebar">
        <div class="close-sidebar" onclick="toggleSidebar()">CLOSE ‚úï</div>
        <h3>Updates</h3>
        <div id="notif-content">
            <p style="color:#888; text-align:center; font-size:12px;">Checking for updates...</p>
        </div>
    </div>

    <div class="header">
        <div class="logo-area">
            <h2>ADRE <span>3.0</span></h2>
        </div>
        <div class="header-actions">
            <button id="login-btn" class="login-btn-header" onclick="openLogin()" style="display:none;">Login</button>
            <button id="profile-btn" class="user-badge" onclick="window.location.href='profile.html'">Hi, Student</button>
            <div class="notif-btn" onclick="toggleSidebar()">
                üîî <div class="red-dot"></div>
            </div>
        </div>
    </div>

    <div id="home-page" class="page-content">
        <h3>Select Subject</h3>
        <p style="color:#aaa; font-size:14px; margin-top:0;">Start your daily practice</p>
        <div class="grid-container">
            <div class="glass-card" onclick="openSubject('Reasoning')"><span class="icon">üß©</span><div class="card-title">Reasoning</div><div class="card-sub">Logic</div></div>
            <div class="glass-card" onclick="openSubject('Maths')"><span class="icon">üìê</span><div class="card-title">Maths</div><div class="card-sub">Quant</div></div>
            <div class="glass-card" onclick="openSubject('GK')"><span class="icon">üåç</span><div class="card-title">GK</div><div class="card-sub">Social Studies</div></div>
            <div class="glass-card" onclick="openSubject('English')"><span class="icon">üìñ</span><div class="card-title">English</div><div class="card-sub">Grammar</div></div>
            <div class="glass-card" onclick="openSubject('Science')"><span class="icon">üß¨</span><div class="card-title">Science</div><div class="card-sub">PCMB</div></div>
            <div class="glass-card" onclick="openSubject('Assam')"><span class="icon">ü¶è</span><div class="card-title">Assam</div><div class="card-sub">Culture</div></div>
            <div class="glass-card" onclick="openSubject('Notes')"><span class="icon">üìö</span><div class="card-title">PDFs & Notes</div><div class="card-sub">Material</div></div>
            <div class="glass-card" onclick="openAbout()">
                <span class="icon">‚ÑπÔ∏è</span>
                <div class="card-title">About App</div>
                <div class="card-sub">Vision & Team</div>
            </div>
        </div>

        <div class="leaderboard-container">
            <div class="lb-title">üèÜ Top Scorers</div>
            <div class="lb-header">
                <span>Rank / Candidate</span>
                <span>Score</span>
            </div>
            <ul class="lb-list" id="leaderboard-list">
                <p style="text-align:center; color:#888; padding:20px;">Loading Leaderboard...</p>
            </ul>
        </div>
    </div>

    <div id="subject-page" class="page-content">
        <button class="back-btn" onclick="goHome()">‚Üê Back</button>
        <h1 id="subject-title">Subject</h1>
        <ul class="chapter-list" id="chapter-list-container"></ul>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-box">
            <span onclick="closeLogin()" style="float:right; cursor:pointer;">‚úï</span>
            <h2 id="login-title">Student Login</h2>
            <div id="step-1">
                <input type="text" id="name-input" class="input-field" placeholder="Full Name">
                <input type="email" id="email-input" class="input-field" placeholder="Email">
                <button onclick="sendOtp()" class="submit-btn">Get OTP Code</button>
            </div>
            <div id="step-2" style="display:none;">
                <input type="text" id="otp-input" class="input-field" placeholder="Enter 6-digit Code">
                <button onclick="verifyOtp()" class="submit-btn">Verify & Login</button>
            </div>
            <p id="login-msg" style="color:var(--wrong-red); font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="about-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px; max-height:80vh; overflow-y:auto;">
            <span onclick="document.getElementById('about-modal').style.display='none'" style="float:right; cursor:pointer;">‚úï</span>
            
            <span class="dev-role">Developer</span>
            <img src="image.jpg" alt="Dev" class="dev-avatar">
            <h3 style="margin: 5px 0; color: white;">Abhik Dutta</h3>
            <span style="color: #aaa; font-size: 12px;">B.Voc in IT</span>
            <p class="dev-bio">"Hi, I built ADRE 3.0 Prep to make education free and accessible for all. Best of luck!"</p>
            <a href="mailto:Abhikdutta639@gmail.com" class="dev-contact">üìß Abhikdutta639@gmail.com</a>
            
            <hr style="border:1px solid #333; margin:15px 0;">

            <h3 style="margin-top:0; font-size:16px;">üí° Suggestions?</h3>
            <form id="feedback-form" action="https://formspree.io/f/xeeqqanb" method="POST" onsubmit="handleFeedback(event)">
                <input type="hidden" name="name" id="hidden-name">
                <input type="hidden" name="email" id="hidden-email">
                <textarea name="message" placeholder="Found a bug? Suggestion?" required></textarea>
                <button type="submit" id="form-btn" class="submit-btn" style="margin-top:5px;">Send Feedback üöÄ</button>
                <p id="form-status" style="display:none; font-size:12px; margin-top:5px;"></p>
            </form>
        </div>
    </div>

    <div id="share-modal" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size:40px; margin-bottom:10px;">üîí</div>
            <h2 style="color:var(--neon-blue);">Unlock Premium Mocks</h2>
            <p style="color:#ccc; font-size:14px; margin-bottom:20px;">Tests take effort to create. Help us grow by sharing with 5 friends.</p>
            
            <button onclick="shareOnWhatsApp()" class="submit-btn" style="background:#25D366; color:white; display:flex; align-items:center; justify-content:center; gap:10px;">
                <span>üöÄ Share on WhatsApp</span>
            </button>
            <button onclick="document.getElementById('share-modal').style.display='none'" style="background:transparent; border:none; color:#aaa; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="share-error-modal" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size:40px; margin-bottom:10px;">‚ö†Ô∏è</div>
            <h2 style="color:var(--wrong-red);">Sharing Failed</h2>
            <p style="color:#ccc; font-size:14px; margin-bottom:20px;">It looks like you returned too quickly. Please share on WhatsApp to unlock.</p>
            <button onclick="shareOnWhatsApp()" class="submit-btn" style="background:#25D366; color:white;">Try Again üöÄ</button>
            <button onclick="document.getElementById('share-error-modal').style.display='none'" style="background:transparent; border:none; color:#aaa; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="install-popup" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:rgba(20, 20, 30, 0.95); border:1px solid #00f2ff; border-radius:15px; padding:20px; text-align:center; z-index:9999; backdrop-filter:blur(10px); box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="margin:0 0 10px 0; color:#fff;">Install App</h3>
        <p style="color:#ccc; font-size:14px; margin-bottom:20px;">Install ADRE Prep for a better fullscreen experience.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="dismissInstall()" style="background:transparent; border:1px solid #555; color:#aaa; padding:10px 20px; border-radius:20px; cursor:pointer;">Later</button>
            <button id="install-btn" style="background:#00f2ff; border:none; color:#000; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">Install Now</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const MENU_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRO7WqDZ2QCRy-Hng8vdpVGTsSm4lp8n5gamqUSF5J1I-6jVtK1UZLHOYMN7p_xSpFI3RGuuPH3l35M/pub?gid=0&single=true&output=csv';
        const NOTIF_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRtoNQB-1KLeROQT5KvryYIcvc-ooEVOBFg-r_H1cFkrjCAPUbbGoZ8Evrli4N6qiKRWUeT2BPUqvcn/pub?output=csv';
        const SUPABASE_URL = 'https://blltdzrfgryijzoastmt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_H0S0tAon1YanWFgKTWoilA_wMKZRZ5j'; 

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null; 
        let tempEmail = ""; 
        let shareStartTime = 0; 

        // --- 1. DYNAMIC SUBJECT LOADER ---
        async function openSubject(subjectName) { 
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('subject-page').style.display = 'block';
            document.getElementById('subject-title').innerText = (subjectName === 'Notes') ? "PDFs & Notes" : subjectName + " Prep";
            
            const listContainer = document.getElementById('chapter-list-container');
            listContainer.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Loading list...</p>';

            const isUnlocked = localStorage.getItem('referral_done') === 'true';

            try {
                const response = await fetch(MENU_SHEET_URL);
                if (!response.ok) throw new Error("Menu Sheet not found");
                const data = await response.text();
                const rows = data.split(/\r?\n/).slice(1);
                
                let html = "";
                let count = 0; 

                rows.forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                    
                    if(cols.length >= 4) {
                        const rowSubject = cols[0];
                        const btnName = cols[1];
                        const value = cols[2];
                        const type = cols[3];

                        if(rowSubject === subjectName) {
                            let isLocked = false;
                            if (type !== 'PDF' && count > 0 && !isUnlocked) {
                                isLocked = true;
                            }

                            if(type === 'PDF') {
                                html += `<li class="chapter-item" onclick="window.open('${value}', '_blank')"><span>${btnName}</span><span class="lock-indicator">üìÑ</span></li>`;
                            } else {
                                if(isLocked) {
                                    html += `<li class="chapter-item locked-referral" onclick="openShareModal()"><span>${btnName}</span><span class="lock-indicator">üîí</span></li>`;
                                } else {
                                    let lockIcon = currentUser ? "üëâ" : "üîí"; 
                                    html += `<li class="chapter-item" onclick="attemptOpen('exam.html?id=${value}&subject=${subjectName}', true)"><span>${btnName}</span><span class="lock-indicator">${lockIcon}</span></li>`;
                                }
                            }
                            count++;
                        }
                    }
                });

                listContainer.innerHTML = (count === 0) ? `<p style="text-align:center; color:#666;">No content added for ${subjectName} yet.</p>` : html;
                updateAttemptedVisuals();

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<p style="text-align:center; color:red;">Failed to load menu.</p>';
            }
        }

       // --- 2. REFERRAL & ABOUT LOGIC (FIXED) ---
        function openAbout() { document.getElementById('about-modal').style.display='flex'; }
        function openShareModal() { document.getElementById('share-modal').style.display = 'flex'; }

        function shareOnWhatsApp() {
            document.getElementById('share-error-modal').style.display = 'none';
            // UPDATED: Changed the link from netlify.app to your github.io URL
            const message = "Hey! I found this amazing free Mock Test app for ADRE 3.0. Practicing here helps a lot! Check it out: https://ab2001k.github.io/adre-prep/";
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            
            shareStartTime = Date.now(); 
            window.open(url, '_blank');
            
            // FIX: Wait 1 second before listening for return. 
            // This prevents the browser from triggering "failed" immediately.
            setTimeout(() => {
                // Listen for both visibility change (Mobile) and focus (Desktop)
                document.addEventListener("visibilitychange", checkShareSuccess, { once: true });
                window.addEventListener("focus", checkShareSuccess, { once: true });
            }, 1000);
        }

        function checkShareSuccess() {
            // Clean up listeners to prevent double-firing
            document.removeEventListener("visibilitychange", checkShareSuccess);
            window.removeEventListener("focus", checkShareSuccess);

            const timeSpent = Date.now() - shareStartTime;
            
            // LOGIC: If they return in less than 2.5 seconds (2500ms), they didn't share.
            // (Lowered from 3000ms to be smoother)
            if(timeSpent < 2500) {
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('share-error-modal').style.display = 'flex';
            } else {
                localStorage.setItem('referral_done', 'true');
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('share-error-modal').style.display = 'none';
                alert("üéâ Content Unlocked! Thank you for sharing.");
                
                // Reload current subject to update lock icons
                const currentTitle = document.getElementById('subject-title').innerText.replace(" Prep", "");
                openSubject(currentTitle);
            }
        }

        // --- 3. AUTHENTICATION ---
        async function sendOtp() {
            const name = document.getElementById('name-input').value;
            const email = document.getElementById('email-input').value;
            if(name.length < 2 || !email.includes('@')) return;
            document.getElementById('login-msg').innerText = "Sending...";
            tempEmail = email;
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { data: { full_name: name } } });
            if (error) document.getElementById('login-msg').innerText = "Error: " + error.message; 
            else { 
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
                document.getElementById('login-msg').innerText = "OTP Sent!";
            }
        }

        async function verifyOtp() {
            const token = document.getElementById('otp-input').value;
            const { data, error } = await _supabase.auth.verifyOtp({ email: tempEmail, token, type: 'email' });
            if (error) document.getElementById('login-msg').innerText = "Wrong Code!"; 
            else { 
                document.getElementById('login-msg').innerText = "Success!"; 
                const { user } = data;
                if(user) {
                    const name = user.user_metadata.full_name || "Student";
                    await _supabase.from('profiles').upsert({ id: user.id, full_name: name }, { onConflict: 'id', ignoreDuplicates: true }); 
                }
                setTimeout(() => { closeLogin(); location.reload(); }, 1000); 
            }
        }

        // --- 4. UTILITIES ---
        function getStorageKey() { return currentUser ? "attempts_" + currentUser.id : "attempts_guest"; }
        
        function attemptOpen(url, req) {
            if (req && !currentUser) { alert("Login Required!"); openLogin(); } 
            else { 
                const key = getStorageKey();
                let attempts = JSON.parse(localStorage.getItem(key)) || [];
                if (!attempts.includes(url)) { attempts.push(url); localStorage.setItem(key, JSON.stringify(attempts)); }
                window.location.href = url; 
            }
        }

        function updateAttemptedVisuals() {
            const key = getStorageKey();
            const attempts = JSON.parse(localStorage.getItem(key)) || [];
            document.querySelectorAll('.chapter-item').forEach(item => {
                const onclickText = item.getAttribute('onclick');
                if (onclickText && attempts.some(url => onclickText.includes(url))) {
                    item.classList.add('attempted');
                    const icon = item.querySelector('.lock-indicator');
                    if (icon && (icon.innerText === "üëâ" || icon.innerText === "üîí")) icon.innerText = "‚úÖ";
                }
            });
        }

        function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            if(!list) return;
            _supabase.from('profiles').select('full_name, total_score').eq('is_public', true).order('total_score', { ascending: false }).limit(50)
            .then(({ data }) => {
                list.innerHTML = "";
                if(!data || data.length === 0) list.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No scores yet.</p>';
                else data.forEach((user, index) => {
                    let rankClass = index === 0 ? "rank-1" : index === 1 ? "rank-2" : index === 2 ? "rank-3" : "";
                    
                    // Generate Initials
                    let initials = user.full_name ? user.full_name.charAt(0).toUpperCase() : "?";
                    
                    // New Structure
                    list.innerHTML += `
                    <li class="lb-item ${rankClass}">
                        <div class="lb-left-grp">
                            <span class="lb-rank">${index + 1}</span>
                            <div class="lb-avatar">${initials}</div>
                            <span class="lb-name">${user.full_name}</span>
                        </div>
                        <span class="lb-score">${user.total_score || 0} pts</span>
                    </li>`;
                });
            });
        }

        function goHome() { document.getElementById('subject-page').style.display = 'none'; document.getElementById('home-page').style.display = 'block'; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.red-dot').style.display = 'none'; }
        function openLogin() { document.getElementById('login-modal').style.display = 'flex'; }
        function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }

        async function loadNotifications() {
            try {
                const response = await fetch(NOTIF_SHEET_URL);
                if (!response.ok) return;
                const data = await response.text();
                const rows = data.split(/\r?\n/).slice(1);
                const sb = document.getElementById('notif-content');
                if(rows.length > 0) { sb.innerHTML = ''; document.querySelector('.red-dot').style.display = 'block'; }
                rows.forEach(row => {
                    const c = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(c.length >= 3) {
                       const title = c[0].replace(/^"|"$/g, '').trim();
                       const msg = c[1].replace(/^"|"$/g, '').trim();
                       const date = c[2].replace(/^"|"$/g, '').trim();
                       const link = c[3] ? c[3].replace(/^"|"$/g, '').trim() : "#";
                       const div = document.createElement('div'); div.className = 'notif-item';
                       div.innerHTML = (link.length > 1) ? 
                           `<div onclick="window.location.href='${link}'" style="cursor:pointer"><h4 style="color:#00f2ff; text-decoration:underline">${title} <span style="float:right; color:#888; font-weight:normal;">${date}</span></h4><p>${msg}</p></div>` : 
                           `<h4>${title} <span style="float:right; color:#888; font-weight:normal;">${date}</span></h4><p>${msg}</p>`;
                       sb.appendChild(div);
                    }
                });
            } catch(e) {}
        }

        // --- 5. PWA INSTALL LOGIC ---
        if ('serviceWorker' in navigator) {
            const link = document.createElement('link'); link.rel = 'manifest'; link.href = 'manifest.json'; document.head.appendChild(link);
            navigator.serviceWorker.register('sw.js');
        }
        let deferredPrompt;
        const installPopup = document.getElementById('install-popup');
        const installBtn = document.getElementById('install-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            setTimeout(() => { installPopup.style.display = 'block'; }, 10000);
        });
        function dismissInstall() { installPopup.style.display = 'none'; }
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null; installPopup.style.display = 'none';
            }
        });
        window.addEventListener('appinstalled', () => { installPopup.style.display = 'none'; deferredPrompt = null; });

        // --- INIT ---
    window.onload = async function() {
    // 1. Check if user is logged in
    const { data: { user } } = await _supabase.auth.getUser();

    // GET BUTTONS
    const loginBtn = document.getElementById('login-btn');
    const profileBtn = document.getElementById('profile-btn');

    if (!user) {
        // --- GUEST MODE ---
        if(loginBtn) loginBtn.style.display = 'block';
        if(profileBtn) profileBtn.style.display = 'none';
        
        loadLeaderboard();
        loadNotifications();
        return; 
    }

    // --- LOGGED IN MODE ---
    currentUser = user; 
    if(loginBtn) loginBtn.style.display = 'none';
    
    if (profileBtn) {
        profileBtn.style.display = 'block'; 
        profileBtn.onclick = function() { window.location.href = 'profile.html'; };

        // Fetch Name
        let displayName = "Student"; 
        try {
            const { data: profile } = await _supabase
                .from('profiles').select('full_name').eq('id', user.id).single();
            
            if (profile && profile.full_name) displayName = profile.full_name;
            else if (user.user_metadata.full_name) displayName = user.user_metadata.full_name;
        } catch (error) { console.log(error); }

        profileBtn.innerText = `Hi, ${displayName}`;
    }

    // Pre-fill hidden forms
    if(document.getElementById('hidden-name')) {
        document.getElementById('hidden-name').value = user.user_metadata.full_name || "Student";
        document.getElementById('hidden-email').value = user.email;
    }
    
    // Load Data
    updateAttemptedVisuals();
    loadLeaderboard();
    loadNotifications();
};

    // --- SOUND & PROTECTION SYSTEM (ADDED) ---
    // 1. Click Sound Logic (Base64 encoded short 'pop' sound to avoid external lag)
    const clickSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU..."); 
    // Note: The string above is a placeholder for a real short base64 sound. 
    // Here is a real, tiny Base64 "pop" sound:
    const popAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=");
    
    // Better Pop Sound (Short Blip)
    const btnSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAABAFhUQUcAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUQUcAAAAgAAADbWlub3JfdmVyc2lvbgAwAAADY29tcGF0aWJsZV9icmFuZHMAbXA0Mmlzb21tcDQyAAAAMlRTSVMAAAAaAAADZW5jb2RlcgBMYXZmNTguMjkuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAH");

    function playClick() {
        // Reset time to allow rapid clicking
        btnSound.currentTime = 0;
        btnSound.play().catch(e => { /* Ignore auto-play errors */ });
    }

    // Attach sound to all clickable elements
    document.addEventListener('click', function(e) {
        if(e.target.closest('button') || 
           e.target.closest('.glass-card') || 
           e.target.closest('.chapter-item') || 
           e.target.closest('.notif-btn') || 
           e.target.closest('.close-sidebar')) {
            playClick();
        }
    });

    // 2. Disable Content Copying (Right Click & Keyboard Shortcuts)
    document.addEventListener('contextmenu', event => event.preventDefault()); // Block Right Click

    document.addEventListener('keydown', function(e) {
        // Block Ctrl+C, Ctrl+U (View Source), Ctrl+S (Save), Ctrl+P (Print)
        if (e.ctrlKey && (e.key === 'c' || e.key === 'u' || e.key === 's' || e.key === 'p')) {
            e.preventDefault();
        }
        // Block F12 (Dev Tools) - Optional, but requested for protection
        if(e.key === 'F12') {
            e.preventDefault();
        }
    });

    </script>
</body>
</html>