<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADRE 3.0 Pro</title>
    
    <link rel="icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png" />
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "f1fddec2-1dd5-47b4-b35f-ca39df0bd164",
          safari_web_id: "web.onesignal.auto.662c778c-4ab6-4517-8ad0-9e9a32a53670",
          notifyButton: { enable: false },
        });
        if (Notification.permission === "denied") document.getElementById('perm-warning').style.display = 'block';
      });
    </script>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- GLOBAL STYLES --- */
        :root { --glass-bg: rgba(255, 255, 255, 0.05); --glass-border: 1px solid rgba(255, 255, 255, 0.1); --neon-blue: #00f2ff; --text-color: #ffffff; --wrong-red: #ff4b4b; --correct-green: #00ff88; }
        
        body { 
            margin: 0; font-family: 'Outfit', sans-serif; 
            background: radial-gradient(circle at top, #1b2735 0%, #090a0f 100%); 
            color: var(--text-color); min-height: 100vh; overflow-x: hidden;
            -webkit-user-select: none; user-select: none; /* Anti-Copy */
        }

        #perm-warning { display: none; background: rgba(255, 75, 75, 0.15); backdrop-filter: blur(10px); color: #ff4b4b; text-align: center; padding: 10px; font-size: 13px; border-bottom: 1px solid rgba(255, 75, 75, 0.3); position: sticky; top: 0; z-index: 1001; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .logo-area h2 { margin: 0; font-weight: 700; letter-spacing: 1px; } .logo-area span { color: var(--neon-blue); }
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .notif-btn { background: var(--glass-bg); border: var(--glass-border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; font-size: 20px; }
        .red-dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: #ff4b4b; border-radius: 50%; box-shadow: 0 0 5px #ff4b4b; display: none; }
        .login-btn-header { background: var(--neon-blue); color: #000; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 14px; }
        
        .user-badge { display: none; font-size: 14px; font-weight: bold; color: #00ff88; border: 1px solid #00ff88; padding: 5px 12px; border-radius: 20px; background: rgba(0, 255, 136, 0.1); text-transform: capitalize; cursor: pointer; font-family: 'Outfit', sans-serif; }
        
        /* SIDEBAR */
        .sidebar { position: fixed; top: 0; right: -320px; width: 280px; height: 100vh; background: rgba(13, 14, 20, 0.95); backdrop-filter: blur(20px); border-left: 1px solid rgba(255,255,255,0.1); transition: 0.4s; z-index: 1000; padding: 20px; box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
        .sidebar.active { right: 0; } .close-sidebar { text-align: right; cursor: pointer; color: #aaa; margin-bottom: 20px; }
        .notif-item { padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 10px; border-left: 3px solid var(--neon-blue); }
        .notif-item h4 { margin: 0 0 5px 0; font-size: 14px; } .notif-item p { margin: 0; font-size: 12px; color: #bbb; }
        
        /* PAGE CONTENT */
        .page-content { padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-top: 20px; }
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(12px); border: var(--glass-border); border-radius: 20px; padding: 25px 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; animation: float 6s ease-in-out infinite; }
        .glass-card:hover { background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); transform: scale(1.02); animation-play-state: paused; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0px); } }
        .icon { font-size: 32px; display: block; margin-bottom: 10px; } .card-title { font-weight: 600; font-size: 16px; margin-bottom: 5px; } .card-sub { font-size: 12px; color: #aaa; }
        
        /* SUBJECT PAGE */
        #subject-page { display: none; }
        .back-btn { background: transparent; border: 1px solid #aaa; color: #aaa; padding: 8px 16px; border-radius: 20px; cursor: pointer; margin-bottom: 20px; }
        .chapter-list { list-style: none; padding: 0; }
        .chapter-item { background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; }
        .chapter-item.attempted { border-left: 4px solid #00ff88; background: rgba(0, 255, 136, 0.05); }
        .chapter-item.attempted span:first-child { color: #00ff88; } .chapter-item.attempted .lock-indicator { color: #00ff88; }
        .chapter-item.locked-referral { border-left: 4px solid #ffcc00; opacity: 0.8; }
        .chapter-item.locked-referral .lock-indicator { color: #ffcc00; }
        
        /* LEADERBOARD */
        .leaderboard-container { margin-top: 40px; background: rgba(13, 14, 20, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .lb-title { text-align: center; font-size: 20px; color: var(--neon-blue); padding: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; }
        .lb-header { display: flex; justify-content: space-between; padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #888; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .lb-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #333 transparent; }
        .lb-list::-webkit-scrollbar { width: 6px; } .lb-list::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .lb-item { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); align-items: center; transition: 0.2s; }
        .lb-item:hover { background: rgba(255,255,255,0.03); }
        .lb-left-grp { display: flex; align-items: center; gap: 15px; flex: 1; }
        .lb-rank { width: 25px; font-weight: bold; color: #666; font-size: 14px; text-align: center; }
        
        /* Leaderboard Avatar */
        .lb-avatar { width: 32px; height: 32px; background: linear-gradient(135deg, #333, #555); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #fff; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        .lb-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .lb-name { text-align: left; font-size: 14px; color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; margin-left: 10px; }
        .lb-score { font-weight: bold; color: #00ff88; font-size: 14px; }
        
        .rank-1 .lb-rank { content: "ü•á"; font-size: 20px; text-indent: -1000px; position: relative; } 
        .rank-1 .lb-rank::after { content: "ü•á"; position: absolute; top: -5px; left: 0; text-indent: 0; } 
        .rank-1 { background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; }
        .rank-1 .lb-avatar { background: #ffd700; color: #000; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); border:none; }
        .rank-2 .lb-rank { content: "ü•à"; font-size: 20px; text-indent: -1000px; position: relative; } 
        .rank-2 .lb-rank::after { content: "ü•à"; position: absolute; top: -5px; left: 0; text-indent: 0; } 
        .rank-2 { background: rgba(192, 192, 192, 0.1); border-left: 3px solid #c0c0c0; }
        .rank-2 .lb-avatar { background: #c0c0c0; color: #000; box-shadow: 0 0 10px rgba(192, 192, 192, 0.4); border:none; }
        .rank-3 .lb-rank { content: "ü•â"; font-size: 20px; text-indent: -1000px; position: relative; } 
        .rank-3 .lb-rank::after { content: "ü•â"; position: absolute; top: -5px; left: 0; text-indent: 0; } 
        .rank-3 { background: rgba(205, 127, 50, 0.1); border-left: 3px solid #cd7f32; }
        .rank-3 .lb-avatar { background: #cd7f32; color: #000; box-shadow: 0 0 10px rgba(205, 127, 50, 0.4); border:none; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: #1a1f2e; border: 1px solid #444; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; position: relative; }
        .input-field { width: 90%; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #222; color: white; margin-bottom: 10px; }
        .submit-btn { background: var(--neon-blue); color: #000; border: none; width: 100%; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="header">
        <div class="logo-area"><h2>ADRE <span>3.0</span></h2></div>
        <div class="header-actions">
            <button id="login-btn" class="login-btn-header" onclick="openLogin()">Login</button>
            <button id="profile-btn" class="user-badge" onclick="window.location.href='profile.html'">Hi, Student</button>
            <div class="notif-btn" onclick="toggleSidebar()">
                üîî <div class="red-dot"></div>
            </div>
        </div>
    </div>

    <div id="sidebar" class="sidebar">
        <div class="close-sidebar" onclick="toggleSidebar()">CLOSE ‚úï</div>
        <h3>Updates</h3>
        <div id="notif-content">
            <p style="color:#888; text-align:center; font-size:12px;">Checking for updates...</p>
        </div>
    </div>

    <div id="home-page" class="page-content">
        <h3>Select Subject</h3>
        <div class="grid-container">
            <div class="glass-card" onclick="openSubject('Reasoning')"><span class="icon">üß©</span><div class="card-title">Reasoning</div><div class="card-sub">Logic</div></div>
            <div class="glass-card" onclick="openSubject('Maths')"><span class="icon">üìê</span><div class="card-title">Maths</div><div class="card-sub">Quant</div></div>
            <div class="glass-card" onclick="openSubject('GK')"><span class="icon">üåç</span><div class="card-title">GK</div><div class="card-sub">Social Studies</div></div>
            <div class="glass-card" onclick="openSubject('English')"><span class="icon">üìñ</span><div class="card-title">English</div><div class="card-sub">Grammar</div></div>
            <div class="glass-card" onclick="openSubject('Science')"><span class="icon">üß¨</span><div class="card-title">Science</div><div class="card-sub">PCMB</div></div>
            <div class="glass-card" onclick="openSubject('Assam')"><span class="icon">ü¶è</span><div class="card-title">Assam</div><div class="card-sub">Culture</div></div>
            <div class="glass-card" onclick="openSubject('Notes')"><span class="icon">üìö</span><div class="card-title">PDFs & Notes</div><div class="card-sub">Material</div></div>
            <div class="glass-card" onclick="openAbout()">
                <span class="icon">‚ÑπÔ∏è</span>
                <div class="card-title">About App</div>
                <div class="card-sub">Vision & Team</div>
            </div>
        </div>

        <div class="leaderboard-container">
            <div class="lb-title">üèÜ Top Scorers</div>
            <ul class="lb-list" id="leaderboard-list">
                <p style="text-align:center; padding:20px; color:#666;">Loading...</p>
            </ul>
        </div>
    </div>

    <div id="subject-page">
        <div class="page-content">
            <button class="back-btn" onclick="goHome()">‚Üê Back</button>
            <h1 id="subject-title">Subject</h1>
            <ul class="chapter-list" id="chapter-list-container"></ul>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-box">
            <span onclick="document.getElementById('login-modal').style.display='none'" style="float:right; cursor:pointer;">‚úï</span>
            <h2>Student Login</h2>
            <div id="step-1">
                <input type="text" id="name-input" class="input-field" placeholder="Full Name">
                <input type="email" id="email-input" class="input-field" placeholder="Email">
                <button onclick="sendOtp()" class="submit-btn">Get OTP Code</button>
            </div>
            <div id="step-2" style="display:none;">
                <input type="text" id="otp-input" class="input-field" placeholder="Enter 6-digit Code">
                <button onclick="verifyOtp()" class="submit-btn">Verify & Login</button>
            </div>
            <p id="login-msg" style="color:#ff4b4b; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="share-modal" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size:40px; margin-bottom:10px;">üîí</div>
            <h2 style="color:var(--neon-blue);">Unlock Premium Mocks</h2>
            <p style="color:#ccc; font-size:14px; margin-bottom:20px;">Tests take effort to create. Help us grow by sharing with 5 friends.</p>
            <button onclick="shareOnWhatsApp()" class="submit-btn" style="background:#25D366; color:white; display:flex; align-items:center; justify-content:center; gap:10px;">
                <i class="fa-brands fa-whatsapp" style="font-size:20px;"></i>
                <span>Share on WhatsApp</span>
            </button>
            <button onclick="document.getElementById('share-modal').style.display='none'" style="background:transparent; border:none; color:#aaa; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="share-error-modal" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size:40px; margin-bottom:10px;">‚ö†Ô∏è</div>
            <h2 style="color:var(--wrong-red);">Sharing Failed</h2>
            <p style="color:#ccc; font-size:14px; margin-bottom:20px;">It looks like you returned too quickly. Please share on WhatsApp to unlock.</p>
            <button onclick="shareOnWhatsApp()" class="submit-btn" style="background:#25D366; color:white;">Try Again üöÄ</button>
            <button onclick="document.getElementById('share-error-modal').style.display='none'" style="background:transparent; border:none; color:#aaa; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="about-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:400px; max-height:80vh; overflow-y:auto;">
            <span onclick="document.getElementById('about-modal').style.display='none'" style="float:right; cursor:pointer;">‚úï</span>
            <span style="font-size:12px; color:#aaa; font-weight:bold;">DEVELOPER</span>
            <img src="image.jpg" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--neon-blue); margin:10px auto; display:block;">
            <h3 style="margin: 5px 0; color: white;">Abhik Dutta</h3>
            <span style="color: #aaa; font-size: 12px;">B.Voc in IT</span>
            <p style="font-size: 13px; color: #ddd; font-style: italic;">"Hi, I built ADRE 3.0 Prep to make education free and accessible for all. Best of luck!"</p>
            <a href="mailto:Abhikdutta639@gmail.com" style="color:var(--neon-blue); text-decoration:none; font-size:14px; font-weight:bold;">üìß Abhikdutta639@gmail.com</a>
        </div>
    </div>

    <div id="install-popup" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:rgba(20, 20, 30, 0.95); border:1px solid #00f2ff; border-radius:15px; padding:20px; text-align:center; z-index:9999; backdrop-filter:blur(10px); box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="margin:0 0 10px 0; color:#fff;">Install App</h3>
        <p style="color:#ccc; font-size:14px; margin-bottom:20px;">Install ADRE Prep for a better fullscreen experience.</p>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button onclick="dismissInstall()" style="background:transparent; border:1px solid #555; color:#aaa; padding:10px 20px; border-radius:20px; cursor:pointer;">Later</button>
            <button id="install-btn" style="background:#00f2ff; border:none; color:#000; padding:10px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">Install Now</button>
        </div>
    </div>

    <script>
        // CONFIG
        const MENU_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRO7WqDZ2QCRy-Hng8vdpVGTsSm4lp8n5gamqUSF5J1I-6jVtK1UZLHOYMN7p_xSpFI3RGuuPH3l35M/pub?gid=0&single=true&output=csv';
        const NOTIF_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRtoNQB-1KLeROQT5KvryYIcvc-ooEVOBFg-r_H1cFkrjCAPUbbGoZ8Evrli4N6qiKRWUeT2BPUqvcn/pub?output=csv';
        const SUPABASE_URL = 'https://blltdzrfgryijzoastmt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_H0S0tAon1YanWFgKTWoilA_wMKZRZ5j'; 

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null; 
        let tempEmail = ""; 
        let shareStartTime = 0; 
        
        // --- SOUND LOGIC (FIXED) ---
        const btnSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAABAFhUQUcAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUQUcAAAAgAAADbWlub3JfdmVyc2lvbgAwAAADY29tcGF0aWJsZV9icmFuZHMAbXA0Mmlzb21tcDQyAAAAMlRTSVMAAAAaAAADZW5jb2RlcgBMYXZmNTguMjkuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAH");

        function playClick() { 
            const isSoundOn = localStorage.getItem('soundEnabled') !== 'false';
            if(isSoundOn) { 
                btnSound.currentTime = 0; 
                btnSound.play().catch(()=>{}); 
            } 
        }

        // --- SUBJECT LOADING LOGIC ---
        async function openSubject(subjectName) { 
            playClick();
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('subject-page').style.display = 'block';
            document.getElementById('subject-title').innerText = (subjectName === 'Notes') ? "PDFs & Notes" : subjectName + " Prep";
            
            const listContainer = document.getElementById('chapter-list-container');
            listContainer.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px;">Loading list...</p>';

            const isUnlocked = localStorage.getItem('referral_done') === 'true';

            try {
                const response = await fetch(MENU_SHEET_URL);
                if (!response.ok) throw new Error("Menu Sheet not found");
                const data = await response.text();
                const rows = data.split(/\r?\n/).slice(1);
                
                let html = "";
                let count = 0; 

                rows.forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                    if(cols.length >= 4) {
                        const rowSubject = cols[0];
                        const btnName = cols[1];
                        const value = cols[2];
                        const type = cols[3];

                        if(rowSubject === subjectName) {
                            let isLocked = false;
                            if (type !== 'PDF' && count > 0 && !isUnlocked) isLocked = true;

                            if(type === 'PDF') {
                                html += `<li class="chapter-item" onclick="window.open('${value}', '_blank')"><span>${btnName}</span><span class="lock-indicator">üìÑ</span></li>`;
                            } else {
                                if(isLocked) {
                                    html += `<li class="chapter-item locked-referral" onclick="openShareModal()"><span>${btnName}</span><span class="lock-indicator">üîí</span></li>`;
                                } else {
                                    let lockIcon = currentUser ? "üëâ" : "üîí"; 
                                    html += `<li class="chapter-item" onclick="attemptOpen('exam.html?id=${value}&subject=${subjectName}', true)"><span>${btnName}</span><span class="lock-indicator">${lockIcon}</span></li>`;
                                }
                            }
                            count++;
                        }
                    }
                });

                listContainer.innerHTML = (count === 0) ? `<p style="text-align:center; color:#666;">No content added for ${subjectName} yet.</p>` : html;
                updateAttemptedVisuals();

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<p style="text-align:center; color:red;">Failed to load menu.</p>';
            }
        }
        
        function openAbout() { playClick(); document.getElementById('about-modal').style.display='flex'; }

        // --- AUTH ---
        function openLogin() { playClick(); document.getElementById('login-modal').style.display='flex'; }
        
        async function sendOtp() {
            playClick();
            const name = document.getElementById('name-input').value;
            const email = document.getElementById('email-input').value;
            if(name.length < 2 || !email.includes('@')) return;
            document.getElementById('login-msg').innerText = "Sending...";
            tempEmail = email;
            const { error } = await _supabase.auth.signInWithOtp({ email, options: { data: { full_name: name } } });
            if (error) document.getElementById('login-msg').innerText = "Error: " + error.message; 
            else { 
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
                document.getElementById('login-msg').innerText = "OTP Sent!";
            }
        }

        async function verifyOtp() {
            playClick();
            const token = document.getElementById('otp-input').value;
            const { data, error } = await _supabase.auth.verifyOtp({ email: tempEmail, token, type: 'email' });
            if (error) document.getElementById('login-msg').innerText = "Wrong Code!"; 
            else { 
                document.getElementById('login-msg').innerText = "Success!"; 
                const { user } = data;
                if(user) {
                    const name = user.user_metadata.full_name || "Student";
                    await _supabase.from('profiles').upsert({ id: user.id, full_name: name }, { onConflict: 'id', ignoreDuplicates: true }); 
                }
                setTimeout(() => { document.getElementById('login-modal').style.display='none'; location.reload(); }, 1000); 
            }
        }

        // --- INIT & UTILS ---
        window.onload = async function() {
            const { data: { user } } = await _supabase.auth.getUser();
            const loginBtn = document.getElementById('login-btn');
            const profileBtn = document.getElementById('profile-btn');

            if (!user) {
                if(loginBtn) loginBtn.style.display = 'block';
                if(profileBtn) profileBtn.style.display = 'none';
                loadLeaderboard();
                loadNotifications();
                return; 
            }

            currentUser = user; 
            if(loginBtn) loginBtn.style.display = 'none';
            
            if (profileBtn) {
                profileBtn.style.display = 'block'; 
                profileBtn.onclick = function() { playClick(); window.location.href = 'profile.html'; };
                
                let displayName = "Student"; 
                try {
                    const { data: profile } = await _supabase.from('profiles').select('full_name').eq('id', user.id).single();
                    if (profile && profile.full_name) displayName = profile.full_name;
                    else if (user.user_metadata.full_name) displayName = user.user_metadata.full_name;
                } catch (error) { console.log(error); }

                profileBtn.innerText = `Hi, ${displayName}`;
            }

            if(document.getElementById('hidden-name')) {
                document.getElementById('hidden-name').value = user.user_metadata.full_name || "Student";
                document.getElementById('hidden-email').value = user.email;
            }
            
            updateAttemptedVisuals();
            loadLeaderboard();
            loadNotifications();
        };

        function getStorageKey() { return currentUser ? "attempts_" + currentUser.id : "attempts_guest"; }
        
        function attemptOpen(url, req) {
            playClick();
            if (req && !currentUser) { alert("Login Required!"); openLogin(); } 
            else { 
                const key = getStorageKey();
                let attempts = JSON.parse(localStorage.getItem(key)) || [];
                if (!attempts.includes(url)) { attempts.push(url); localStorage.setItem(key, JSON.stringify(attempts)); }
                window.location.href = url; 
            }
        }

        function updateAttemptedVisuals() {
            const key = getStorageKey();
            const attempts = JSON.parse(localStorage.getItem(key)) || [];
            document.querySelectorAll('.chapter-item').forEach(item => {
                const onclickText = item.getAttribute('onclick');
                if (onclickText && attempts.some(url => onclickText.includes(url))) {
                    item.classList.add('attempted');
                    const icon = item.querySelector('.lock-indicator');
                    if (icon && (icon.innerText === "üëâ" || icon.innerText === "üîí")) icon.innerText = "‚úÖ";
                }
            });
        }

        function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            if(!list) return;
            // FILTER: is_public = true
            _supabase.from('profiles').select('full_name, total_score, avatar_url')
                .eq('is_public', true)
                .order('total_score', { ascending: false })
                .limit(50)
                .then(({ data, error }) => {
                    list.innerHTML = "";
                    if(error) {
                        console.error("Leaderboard Error:", error);
                        list.innerHTML = '<p style="text-align:center; color:#666;">Check connection.</p>';
                        return;
                    }
                    if(!data || data.length === 0) {
                        list.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No scores yet.</p>';
                    } else {
                        data.forEach((user, index) => {
                            let rankClass = index === 0 ? "rank-1" : index === 1 ? "rank-2" : index === 2 ? "rank-3" : "";
                            let avatarHtml = "";
                            if(user.avatar_url) {
                                avatarHtml = `<img src="${user.avatar_url}?t=${new Date().getTime()}" alt="A">`;
                            } else {
                                let initials = user.full_name ? user.full_name.charAt(0).toUpperCase() : "?";
                                avatarHtml = initials;
                            }
                            
                            list.innerHTML += `
                            <li class="lb-item ${rankClass}">
                                <div class="lb-left-grp">
                                    <span class="lb-rank">${index + 1}</span>
                                    <div class="lb-avatar">${avatarHtml}</div>
                                    <span class="lb-name">${user.full_name}</span>
                                </div>
                                <span class="lb-score">${user.total_score || 0} pts</span>
                            </li>`;
                        });
                    }
                });
        }

        function goHome() { 
            playClick();
            document.getElementById('subject-page').style.display = 'none'; 
            document.getElementById('home-page').style.display = 'block'; 
        }

        function toggleSidebar() { 
            playClick();
            document.getElementById('sidebar').classList.toggle('active'); 
            document.querySelector('.red-dot').style.display = 'none'; 
        }

        function openShareModal() { playClick(); document.getElementById('share-modal').style.display = 'flex'; }
        
        function shareOnWhatsApp() {
            playClick();
            document.getElementById('share-error-modal').style.display = 'none';
         const message = "Hey! üòä I found this amazing FREE Mock Test app for ADRE 3.0 üìù‚ú® Practicing here really helps to boost confidence and score üìàüî• Check it out üëâ https://ab2001k.github.io/adre-prep/";
const url = `https://wa.me/?text=${encodeURIComponent(message)}`;

            
            shareStartTime = Date.now(); 
            window.open(url, '_blank');
            
            setTimeout(() => {
                document.addEventListener("visibilitychange", checkShareSuccess, { once: true });
                window.addEventListener("focus", checkShareSuccess, { once: true });
            }, 1000);
        }

        function checkShareSuccess() {
            document.removeEventListener("visibilitychange", checkShareSuccess);
            window.removeEventListener("focus", checkShareSuccess);
            const timeSpent = Date.now() - shareStartTime;
            if(timeSpent < 2500) {
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('share-error-modal').style.display = 'flex';
            } else {
                localStorage.setItem('referral_done', 'true');
                document.getElementById('share-modal').style.display = 'none';
                document.getElementById('share-error-modal').style.display = 'none';
                alert("üéâ Content Unlocked! Thank you for sharing.");
                const currentTitle = document.getElementById('subject-title').innerText.replace(" Prep", "");
                openSubject(currentTitle);
            }
        }

        async function loadNotifications() {
            try {
                const response = await fetch(NOTIF_SHEET_URL);
                if (!response.ok) return;
                const data = await response.text();
                const rows = data.split(/\r?\n/).slice(1);
                const sb = document.getElementById('notif-content');
                if(rows.length > 0) { sb.innerHTML = ''; document.querySelector('.red-dot').style.display = 'block'; }
                rows.forEach(row => {
                    const c = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(c.length >= 3) {
                       const title = c[0].replace(/^"|"$/g, '').trim();
                       const msg = c[1].replace(/^"|"$/g, '').trim();
                       const date = c[2].replace(/^"|"$/g, '').trim();
                       const link = c[3] ? c[3].replace(/^"|"$/g, '').trim() : "#";
                       const div = document.createElement('div'); div.className = 'notif-item';
                       div.innerHTML = (link.length > 1) ? 
                           `<div onclick="window.location.href='${link}'" style="cursor:pointer"><h4 style="color:#00f2ff; text-decoration:underline">${title} <span style="float:right; color:#888; font-weight:normal;">${date}</span></h4><p>${msg}</p></div>` : 
                           `<h4>${title} <span style="float:right; color:#888; font-weight:normal;">${date}</span></h4><p>${msg}</p>`;
                       sb.appendChild(div);
                    }
                });
            } catch(e) {}
        }

        // --- PWA INSTALL ---
        if ('serviceWorker' in navigator) {
            const link = document.createElement('link'); link.rel = 'manifest'; link.href = 'manifest.json'; document.head.appendChild(link);
            navigator.serviceWorker.register('sw.js');
        }
        let deferredPrompt;
        const installPopup = document.getElementById('install-popup');
        const installBtn = document.getElementById('install-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            setTimeout(() => { installPopup.style.display = 'block'; }, 10000);
        });
        function dismissInstall() { installPopup.style.display = 'none'; }
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null; installPopup.style.display = 'none';
            }
        });
        window.addEventListener('appinstalled', () => { installPopup.style.display = 'none'; deferredPrompt = null; });

        // --- CONTENT PROTECTION ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && (e.key === 'c' || e.key === 'u' || e.key === 's' || e.key === 'p')) e.preventDefault();
            if(e.key === 'F12') e.preventDefault();
        });
        document.addEventListener('click', function(e) {
            if(e.target.closest('button') || e.target.closest('.glass-card') || e.target.closest('.chapter-item') || e.target.closest('.notif-btn') || e.target.closest('.close-sidebar')) {
                playClick();
            }
        });
    </script>
</body>
</html>
