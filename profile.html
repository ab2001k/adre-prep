<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | ADRE Prep</title>
    <link rel="icon" href="favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        :root { --bg-dark: #090a0f; --glass-bg: rgba(255, 255, 255, 0.05); --glass-border: 1px solid rgba(255, 255, 255, 0.1); --neon-blue: #00f2ff; --text-color: #ffffff; --wrong-red: #ff4b4b; --correct-green: #00ff88; --gold: #ffd700; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: radial-gradient(circle at top, #1b2735 0%, #090a0f 100%); color: var(--text-color); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        .container { width: 100%; max-width: 500px; margin-bottom: 60px; }
        
        .header-row { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #aaa; font-size: 14px; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; }
        
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(12px); border: var(--glass-border); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; position: relative; }
        
        /* Avatar */
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .avatar-container { width: 80px; height: 80px; position: relative; cursor: pointer; flex-shrink: 0; }
        .avatar-circle { width: 100%; height: 100%; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 2px solid var(--neon-blue); overflow: hidden; }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .camera-icon { position: absolute; bottom: 0; right: 0; background: #000; color: #fff; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 1px solid #555; }
        
        .user-info h2 { margin: 0; font-size: 20px; color: white; }
        .user-info p { margin: 5px 0 0; font-size: 12px; color: #aaa; }
        .edit-btn { background: none; border: none; color: var(--neon-blue); cursor: pointer; margin-left: 5px; }

        /* Progress */
        .level-badge { font-size: 12px; color: var(--gold); font-weight: bold; display: block; margin-bottom: 5px; }
        .progress-track { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--neon-blue), var(--correct-green)); width: 0%; transition: width 1s ease; }
        .stats-row { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #ccc; }

        /* Toggles */
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--correct-green); }
        input:checked + .slider:before { transform: translateX(22px); }

        .logout-btn { width: 100%; padding: 12px; background: rgba(255, 75, 75, 0.1); color: var(--wrong-red); border: 1px solid var(--wrong-red); border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }
        /* Socials */
        .social-row { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .social-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; font-size: 18px; transition: 0.3s; }
        .social-btn:hover { background: var(--neon-blue); color: #000; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="container">
        <div class="header-row">
            <a href="index.html" class="back-btn" onclick="playClick()">‚Üê Back</a>
            <span style="font-size:12px; color:#666;">SETTINGS</span>
        </div>

        <div class="glass-card">
            <div class="profile-header">
                <div class="avatar-container" onclick="document.getElementById('file-upload').click()">
                    <div class="avatar-circle" id="avatar-display">üë§</div>
                    <div class="camera-icon"><i class="fa-solid fa-camera"></i></div>
                </div>
                <input type="file" id="file-upload" accept="image/*" style="display:none;" onchange="uploadAvatar(event)">
                
                <div class="user-info">
                    <h2 id="u-name">Student <button class="edit-btn" onclick="editName()"><i class="fa-solid fa-pen"></i></button></h2>
                    <p id="u-email">...</p>
                </div>
            </div>
            
            <span class="level-badge" id="lvl-txt">LEVEL 1</span>
            <div class="progress-track"><div class="progress-fill" id="prog-bar"></div></div>
            <div class="stats-row">
                <span>Score: <b style="color:var(--neon-blue);" id="u-score">0</b></span>
                <span id="next-lvl">Next: 100</span>
            </div>
        </div>

        <div class="glass-card">
            <div class="setting-row">
                <span><i class="fa-solid fa-volume-high" style="color:var(--correct-green); width:25px;"></i> Sound Effects</span>
                <label class="switch">
                    <input type="checkbox" id="sound-toggle" onchange="toggleSound(this)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-row">
                <span><i class="fa-solid fa-earth-americas" style="color:var(--neon-blue); width:25px;"></i> Public Profile</span>
                <label class="switch">
                    <input type="checkbox" id="privacy-toggle" onchange="togglePrivacy(this)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="glass-card" style="text-align:center;">
            <h4 style="margin:0 0 15px 0; color:#aaa;">Share App</h4>
            <div class="social-row">
                <a href="https://wa.me/?text=Try ADRE Prep: https://ab2001k.github.io/adre-prep/" target="_blank" class="social-btn" style="color:#25D366;"><i class="fa-brands fa-whatsapp"></i></a>
                <a href="#" class="social-btn" style="color:#1877F2;"><i class="fa-brands fa-facebook-f"></i></a>
                <a href="#" class="social-btn"><i class="fa-brands fa-x-twitter"></i></a>
            </div>
        </div>

        <button onclick="logout()" class="logout-btn">Log Out</button>
        <div class="footer">Made with ‚ù§Ô∏è in Assam</div>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://blltdzrfgryijzoastmt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_H0S0tAon1YanWFgKTWoilA_wMKZRZ5j'; 
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null;

        // SOUND
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        const clickSound = new Audio("data:audio/mp3;base64,SUQzBAAAAAABAFhUQUcAAAASAAADbWFqb3JfYnJhbmQAbXA0MgBUQUcAAAAgAAADbWlub3JfdmVyc2lvbgAwAAADY29tcGF0aWJsZV9icmFuZHMAbXA0Mmlzb21tcDQyAAAAMlRTSVMAAAAaAAADZW5jb2RlcgBMYXZmNTguMjkuMTAwAAAAAAAAAAAAAAD/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAHP/80DEAAAAA0gAAAAH");

        function playClick() { if(soundEnabled) { clickSound.currentTime=0; clickSound.play().catch(()=>{}); } }
        function toggleSound(el) { soundEnabled = el.checked; localStorage.setItem('soundEnabled', soundEnabled); if(soundEnabled) playClick(); }

        // INIT
        window.onload = async function() {
            document.getElementById('sound-toggle').checked = soundEnabled;
            const { data: { user } } = await _supabase.auth.getUser();
            if(!user) { window.location.href = 'index.html'; return; }
            currentUser = user;

            const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
            const name = profile?.full_name || "Student";
            const score = profile?.total_score || 0;
            
            document.getElementById('u-name').innerHTML = `${name} <button class="edit-btn" onclick="editName()"><i class="fa-solid fa-pen"></i></button>`;
            document.getElementById('u-email').innerText = user.email;
            document.getElementById('u-score').innerText = score;
            document.getElementById('privacy-toggle').checked = profile?.is_public ?? true;

            if(profile?.avatar_url) {
                document.getElementById('avatar-display').innerHTML = `<img src="${profile.avatar_url}?t=${Date.now()}">`;
            } else {
                document.getElementById('avatar-display').innerText = name.charAt(0).toUpperCase();
            }

            // Level Calc
            let lvl = Math.floor(score/100) + 1;
            document.getElementById('lvl-txt').innerText = `LEVEL ${lvl}`;
            document.getElementById('prog-bar').style.width = `${score % 100}%`;
            document.getElementById('next-lvl').innerText = `Next: ${lvl*100}`;
        };

        // UPLOAD
        async function uploadAvatar(e) {
            playClick();
            const file = e.target.files[0];
            if(!file) return;
            if(file.size > 2000000) { alert("File Max 2MB"); return; }

            document.getElementById('avatar-display').innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            const fileName = `${currentUser.id}.${file.name.split('.').pop()}`;
            
            const { error } = await _supabase.storage.from('avatars').upload(fileName, file, { upsert: true });
            if(error) { alert("Upload Failed. Check bucket permissions."); location.reload(); return; }

            const { data } = _supabase.storage.from('avatars').getPublicUrl(fileName);
            await _supabase.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', currentUser.id);
            
            document.getElementById('avatar-display').innerHTML = `<img src="${data.publicUrl}?t=${Date.now()}">`;
        }

        async function togglePrivacy(el) {
            playClick();
            const { error } = await _supabase.from('profiles').update({ is_public: el.checked }).eq('id', currentUser.id);
            if(error) { el.checked = !el.checked; alert("Update failed."); }
        }

        async function editName() {
            playClick();
            let newName = prompt("Enter Name:");
            if(newName) {
                await _supabase.from('profiles').upsert({ id: currentUser.id, full_name: newName });
                location.reload();
            }
        }

        async function logout() {
            playClick();
            await _supabase.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
